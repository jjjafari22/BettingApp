@implements IAsyncDisposable
@using BettingApp.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="top-row ps-3 navbar navbar-dark" style="height: auto; min-height: 3.5rem; padding-top: 1rem; padding-bottom: 1rem;">
    <div class="container-fluid d-flex flex-column align-items-center justify-content-center">
        <a class="navbar-brand mx-0" href="">Castle of Happiness</a>
        <img src="images/logo.png" alt="Logo" class="mt-2" style="width: 80px; height: auto;" />
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

@if (isAdmin && (adminHomeTasks + transactionTasks + userTasks) > 0)
{
    <span class="badge rounded-pill bg-danger navbar-toggler-badge">
        @(adminHomeTasks + transactionTasks + userTasks)
    </span>
}

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="nav flex-column">
        <div class="nav-item px-3">
            @if (isAdmin)
            {
                <NavLink class="nav-link d-flex align-items-center" href="admin" Match="NavLinkMatch.All">
                    <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> 
                    <span>Admin Home</span>
                    @if (adminHomeTasks > 0)
                    {
                        <span class="badge rounded-pill bg-danger ms-2">@adminHomeTasks</span>
                    }
                </NavLink>
            }
            else
            {
                <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                    <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home
                </NavLink>
                
                <NavLink class="nav-link d-flex align-items-center" href="deposit-withdraw">
                    <span class="bi bi-wallet2" style="font-size: 1.25rem; margin-right: 0.75rem; line-height: 1; vertical-align: text-bottom;" aria-hidden="true"></span> 
                    <span>Deposit/Withdrawal</span>
                </NavLink>
            }
        </div>
        <AuthorizeView>
            <Authorized>
                @if (isAdmin)
                {
                    <div class="nav-item px-3">
                        <NavLink class="nav-link d-flex align-items-center" href="admin/transactions">
                            <span class="bi bi-arrow-left-right" style="font-size: 1.25rem; margin-right: 0.75rem; line-height: 1;" aria-hidden="true"></span> 
                            <span>Transactions</span>
                            @if (transactionTasks > 0)
                            {
                                <span class="badge rounded-pill bg-danger ms-2">@transactionTasks</span>
                            }
                        </NavLink>
                    </div>
                    <div class="nav-item px-3">
                        <NavLink class="nav-link d-flex align-items-center" href="admin/creditlimits">
                            <span class="bi bi-cash-coin" style="font-size: 1.25rem; margin-right: 0.75rem; line-height: 1;" aria-hidden="true"></span> 
                            <span>Credit Limits</span>
                        </NavLink>
                    </div>
                    <div class="nav-item px-3">
                        <NavLink class="nav-link d-flex align-items-center" href="admin/users">
                            <span class="bi bi-people-fill" style="font-size: 1.25rem; margin-right: 0.75rem; line-height: 1;" aria-hidden="true"></span> 
                            <span>All Users</span>
                            @if (userTasks > 0)
                            {
                                <span class="badge rounded-pill bg-danger ms-2">@userTasks</span>
                            }
                        </NavLink>
                    </div>
                    <div class="nav-item px-3">
                        <NavLink class="nav-link d-flex align-items-center" href="admin/settings">
                            <span class="bi bi-gear-fill" style="font-size: 1.25rem; margin-right: 0.75rem; line-height: 1;" aria-hidden="true"></span> 
                            <span>Admin Settings</span>
                        </NavLink>
                    </div>
                    <div class="nav-item px-3">
                        <NavLink class="nav-link d-flex align-items-center" href="admin/auditlogs">
                            <span class="bi bi-journal-text" style="font-size: 1.25rem; margin-right: 0.75rem; line-height: 1;" aria-hidden="true"></span> 
                            <span>Audit Logs</span>
                        </NavLink>
                    </div>
                }
            </Authorized>
        </AuthorizeView>

        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Account/Manage">
                        <span class="bi bi-person-fill-nav-menu" aria-hidden="true"></span> @context.User.Identity?.Name
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                        <button type="submit" class="nav-link">
                            <span class="bi bi-arrow-bar-left-nav-menu" aria-hidden="true"></span> Logout
                        </button>
                    </form>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Account/Register">
                        <span class="bi bi-person-nav-menu" aria-hidden="true"></span> Register
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Account/Login">
                        <span class="bi bi-person-badge-nav-menu" aria-hidden="true"></span> Login
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    private string? currentUrl;
    private bool isAdmin;
    private HubConnection? hubConnection;
    // Task Counters
    private int adminHomeTasks = 0;
    private int transactionTasks = 0;
    private int userTasks = 0;

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            var dbUser = await context.Users
                .AsNoTracking()
                .FirstOrDefaultAsync(u => u.UserName == user.Identity.Name);
            isAdmin = dbUser?.IsAdmin ?? false;

            if (isAdmin)
            {
                // Initial Load
                await LoadAdminTasks(context);
                // Setup SignalR for Real-time Updates
                try 
                {
                    hubConnection = new HubConnectionBuilder()
                        .WithUrl(NavigationManager.ToAbsoluteUri("/bethub"))
                        .Build();

                    // Listen for various admin events to refresh counters
                    hubConnection.On<string>("ReceiveAdminNotification", async (message) => await RefreshTasks());
                    hubConnection.On("ReceiveUserRegistration", async () => await RefreshTasks());
                    hubConnection.On<string>("ReceiveUpdate", async (message) => await RefreshTasks());

                    await hubConnection.StartAsync();
                    await hubConnection.InvokeAsync("JoinAdminGroup");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"NavMenu SignalR Error: {ex.Message}");
                }
            }
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        // Also refresh on navigation to be safe
        if (isAdmin)
        {
            _ = InvokeAsync(RefreshTasks);
        }
        else 
        {
            StateHasChanged();
        }
    }

    private async Task RefreshTasks()
    {
        try 
        {
            using var context = DbFactory.CreateDbContext();
            await LoadAdminTasks(context);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing admin tasks: {ex.Message}");
        }
    }

    private async Task LoadAdminTasks(ApplicationDbContext context)
    {
        // Admin Home: Pending bets (review) + Active bets (process outcome)
        var pendingBets = await context.Bets.CountAsync(b => b.Status == "Pending");
        // FIXED: Count Active bets by Status = Approved
        var activeBets = await context.Bets.CountAsync(b => b.Status == "Approved");
        adminHomeTasks = pendingBets + activeBets;
        
        // Transactions: Pending withdrawals
        transactionTasks = await context.Transactions.CountAsync(t => t.Type == "Withdrawal" && t.Status == "Pending");
        // Users: Accounts waiting for approval (EmailConfirmed is false)
        userTasks = await context.Users.CountAsync(u => !u.EmailConfirmed);
    }

    public async ValueTask DisposeAsync()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        if (hubConnection is not null)
        {
            try 
            {
                await hubConnection.DisposeAsync();
            }
            catch { /* Ignore disposal errors */ }
        }
    }
}