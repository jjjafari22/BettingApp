@page "/"
@rendermode @(new InteractiveServerRenderMode(prerender: true))
@using Microsoft.AspNetCore.SignalR
@using BettingApp.Hubs
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using BettingApp.Data
@using Microsoft.EntityFrameworkCore 
@using Azure.Storage.Blobs
@using Azure.Storage.Blobs.Models
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav
@inject BlobServiceClient BlobService
@inject IHubContext<BetHub> HubContext
@inject IConfiguration Config
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

@if (IsLoading)
{
    <div class="alert alert-info">Loading your data...</div>
}

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> 
        <pre>@ErrorMessage</pre>
    </div>
}

@if (!string.IsNullOrEmpty(SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Success!</strong> @SuccessMessage
        <button type="button" class="btn-close" @onclick="() => SuccessMessage = null" aria-label="Close"></button>
    </div>
}

<div class="container mt-4">
    <div class="card bg-light mb-4">
        <div class="card-body text-center">
            <h3>Balance</h3>
            <h1 class="display-4 @GetBalanceClass(Balance)">@Balance.ToString("N0") kr</h1>
            <small class="text-muted">
                Available Credit: <strong>@AvailableCredit.ToString("N0") kr</strong> 
                (Limit: @CreditLimit.ToString("N0") kr)
            </small>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">New Pick</div>
        <div class="card-body">
            <EditForm Model="@newBet" OnValidSubmit="PlaceBet" FormName="PlaceBetForm">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label>Screenshot *</label>
                    <InputFile OnChange="HandleFileSelected" class="form-control" accept="image/*" />
                </div>

                <button type="submit" class="btn btn-primary w-100" disabled="@IsSubmitting">
                   @if (IsSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="ms-2">Sending Pick...</span>
                    }
                    else
                    {
                       <span>Send Pick</span>
                    }
                </button>
            </EditForm>
        </div>
    </div>

    <h4>My Bets History (@totalBets)</h4>
    
    <div class="table-responsive">
        <table class="table align-middle text-nowrap">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Bet Amount</th>
                    <th>Odds</th>
                    <th>Potential Payout</th>
                    <th>Screenshot</th> 
                    <th>Status</th>
                    <th>Bet Outcome</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var bet in myBets)
                {
                    <tr class="@GetRowClass(bet)">
                        <td>@bet.CreatedAt.ToLocalTime().ToShortDateString()</td>
                        <td>@bet.CreatedAt.ToLocalTime().ToShortTimeString()</td>
                        <td>@(bet.AmountNOK ?? 0) kr</td>
                        <td>@bet.Odds.ToString("N2")</td>
                        <td>@bet.PotentialPayout.ToString("N0") kr</td>
                        <td>
                            @if (!string.IsNullOrEmpty(bet.ScreenshotUrl))
                            {
                                <a href="@bet.ScreenshotUrl" target="_blank" class="btn btn-sm btn-outline-primary">View Image</a>
                            }
                            else
                            {
                                <span class="text-muted">None</span>
                            }
                        </td>
                        <td>@bet.Status</td>
                        <td>
                            @if (bet.Outcome == "Won")
                            {
                                <span class="d-inline-block bg-success border border-dark" style="width: 20px; height: 20px;" title="Won"></span>
                                <span class="ms-1">Won</span>
                            }
                            else if (bet.Outcome == "Lost")
                            {
                                <span class="d-inline-block bg-danger border border-dark" style="width: 20px; height: 20px;" title="Lost"></span>
                                <span class="ms-1">Lost</span>
                            }
                            else if (bet.Outcome == "Void")
                            {
                                <span class="d-inline-block bg-warning border border-dark" style="width: 20px; height: 20px;" title="Void"></span>
                                <span class="ms-1">Void</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (bet.Status == "Pending")
                            {
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => CancelBet(bet)">
                                    Cancel
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        
        @* Pagination for Bets *@
        <div class="d-flex justify-content-between align-items-center mt-2 mb-4">
            <button class="btn btn-outline-secondary btn-sm" @onclick="PrevBetsPage" disabled="@(betsPage <= 1)">
                <i class="bi bi-arrow-left"></i> Previous
            </button>
            <span class="text-muted">Page @betsPage</span>
            <button class="btn btn-outline-secondary btn-sm" @onclick="NextBetsPage" disabled="@(!hasMoreBets)">
                Next <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <h4 class="mt-5">My Transactions (@totalTransactions)</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Platform</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            @if (myTransactions.Count == 0)
            {
                <tr><td colspan="4" class="text-center text-muted">No transactions found.</td></tr>
            }
            @foreach (var t in myTransactions)
            {
                <tr>
                    <td>@t.Date.ToLocalTime().ToString("g")</td>
                    <td>
                        <span class="badge @(t.Type == "Deposit" ? "bg-success" : "bg-warning")">
                            @t.Type
                        </span>
                    </td>
                    <td>@t.Platform</td>
                    <td>@t.AmountNOK.ToString("N0") kr</td>
                </tr>
            }
        </tbody>
    </table>
    
    @* Pagination for Transactions *@
    <div class="d-flex justify-content-between align-items-center mt-2 mb-5">
        <button class="btn btn-outline-secondary btn-sm" @onclick="PrevTransPage" disabled="@(transPage <= 1)">
            <i class="bi bi-arrow-left"></i> Previous
        </button>
        <span class="text-muted">Page @transPage</span>
        <button class="btn btn-outline-secondary btn-sm" @onclick="NextTransPage" disabled="@(!hasMoreTrans)">
            Next <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

@code {
    private Bet newBet { get; set; } = new() { Odds = 1.0m }; 
    private List<Bet> myBets = new();
    private List<Transaction> myTransactions = new();
    private decimal CreditLimit = 0;
    private decimal Balance = 0;
    private decimal AvailableCredit = 1000;

    private IBrowserFile? uploadedFile;
    private HubConnection? hubConnection;
    private string userId = string.Empty;
    
    private bool IsLoading = true;
    private bool IsSubmitting = false;
    private string? ErrorMessage;
    private string? SuccessMessage;

    // Pagination State
    private int betsPage = 1;
    private bool hasMoreBets = false;
    private int totalBets = 0; // Field for displaying count

    private int transPage = 1;
    private bool hasMoreTrans = false;
    private int totalTransactions = 0; // Field for displaying count
    
    private const int PageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var auth = await AuthState.GetAuthenticationStateAsync();
            var uid = auth.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (!string.IsNullOrEmpty(uid))
            {
                userId = uid;
                // --- NEW CODE: Redirect Admin to Admin Dashboard ---
                using var context = DbFactory.CreateDbContext();
                var user = await context.Users.AsNoTracking()
                    .Select(u => new { u.Id, u.IsAdmin }) // Optimization: fetch only needed columns
                    .FirstOrDefaultAsync(u => u.Id == userId);

                if (user != null && user.IsAdmin)
                {
                    Nav.NavigateTo("/admin");
                    return; 
                }
                // ---------------------------------------------------

                newBet.UserId = userId;
                newBet.UserName = auth.User.Identity?.Name ?? "Unknown";
            }
        }
        catch (Microsoft.AspNetCore.Components.NavigationException)
        {
            // Rethrow the navigation exception so the framework can handle the redirect
            throw;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Startup Error: {ex.Message}";
            Console.WriteLine(ex);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                if (!string.IsNullOrEmpty(userId))
                {
                    await LoadData();
                    await SetupSignalR();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error loading data: {ex.Message}";
                Console.WriteLine(ex);
            }
            finally
            {
                IsLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadData()
    {      
        using var context = DbFactory.CreateDbContext();
        // 1. Get User Info
        var user = await context.Users.AsNoTracking()
            .FirstOrDefaultAsync(u => u.Id == userId);
        if (user != null)
        {
            CreditLimit = user.CreditLimit;
        }

        // 2. Calculate Balance (Using SumAsync for efficiency)
        var totalDeposits = await context.Transactions
            .Where(t => t.UserId == userId && t.Type == "Deposit")
            .SumAsync(t => t.AmountNOK);

        var totalWithdrawals = await context.Transactions
            .Where(t => t.UserId == userId && t.Type == "Withdrawal")
            .SumAsync(t => t.AmountNOK);
            
        // FIX: Calculate the Payout formula in memory to avoid SQL translation error with Math.Floor
        var winningBets = await context.Bets
            .Where(b => b.UserId == userId && b.Outcome == "Won")
            .Select(b => new { b.AmountNOK, b.Odds })
            .ToListAsync();
            
        var winnings = winningBets.Sum(b => Math.Floor((decimal)(b.AmountNOK ?? 0) * b.Odds));

        var liability = await context.Bets
            .Where(b => b.UserId == userId && 
                       (b.Status == "Pending" || (b.Status == "Approved" && b.Outcome != "Void")))
            .SumAsync(b => (decimal)(b.AmountNOK ?? 0));

        Balance = totalDeposits - totalWithdrawals - liability + winnings;
        AvailableCredit = Balance + CreditLimit;

        // 3. Load Paginated Lists
        await LoadBetsList();
        await LoadTransactionsList();
    }
    
    private async Task LoadBetsList()
    {
        using var context = DbFactory.CreateDbContext();
        totalBets = await context.Bets.CountAsync(b => b.UserId == userId);
        
        myBets = await context.Bets
            .Where(b => b.UserId == userId)
            .OrderByDescending(b => b.CreatedAt)
            .Skip((betsPage - 1) * PageSize)
            .Take(PageSize)
            .AsNoTracking()
            .ToListAsync();
            
        hasMoreBets = totalBets > (betsPage * PageSize);
    }
    
    private async Task LoadTransactionsList()
    {
        using var context = DbFactory.CreateDbContext();
        totalTransactions = await context.Transactions.CountAsync(t => t.UserId == userId);
        
        myTransactions = await context.Transactions
            .Where(t => t.UserId == userId)
            .OrderByDescending(t => t.Date)
            .Skip((transPage - 1) * PageSize)
            .Take(PageSize)
            .AsNoTracking()
            .ToListAsync();
            
        hasMoreTrans = totalTransactions > (transPage * PageSize);
    }

    // Pagination Methods for Bets
    private async Task NextBetsPage()
    {
        betsPage++;
        await LoadBetsList();
    }

    private async Task PrevBetsPage()
    {
        if (betsPage > 1)
        {
            betsPage--;
            await LoadBetsList();
        }
    }

    // Pagination Methods for Transactions
    private async Task NextTransPage()
    {
        transPage++;
        await LoadTransactionsList();
    }

    private async Task PrevTransPage()
    {
        if (transPage > 1)
        {
            transPage--;
            await LoadTransactionsList();
        }
    }

    private async Task SetupSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/bethub"))
            .Build();

        hubConnection.On<string>("ReceiveUpdate", async (message) =>
        {
            // Reload data but keep current page
            await LoadData();
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        await hubConnection.InvokeAsync("JoinUserGroup", userId);
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
    }

    private async Task PlaceBet()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsSubmitting = true;

        try
        {
            if (uploadedFile == null)
            {
                ErrorMessage = "You must upload a screenshot for your pick.";
                IsSubmitting = false;
                return;
            }

            if (uploadedFile != null)
            {
                // Scale the image in the browser (max 1200px width/height) before uploading
                var resizedFile = await uploadedFile.RequestImageFileAsync("image/jpeg", 1200, 1200);
                
                // --- NEW AZURE BLOB UPLOAD LOGIC ---
                var containerClient = BlobService.GetBlobContainerClient("uploads");
                
                // CHANGE: Ensure container is Public so images can be viewed
                await containerClient.CreateIfNotExistsAsync(PublicAccessType.Blob);
                await containerClient.SetAccessPolicyAsync(PublicAccessType.Blob);

                var fileName = $"{Guid.NewGuid()}.jpg";
                var blobClient = containerClient.GetBlobClient(fileName);

                await using var stream = resizedFile.OpenReadStream(maxAllowedSize: 2000000);
                // IMPORTANT: Set Content-Type so browsers display it instead of downloading
                var headers = new BlobHttpHeaders { ContentType = "image/jpeg" };
                await blobClient.UploadAsync(stream, new BlobUploadOptions { HttpHeaders = headers });

                newBet.ScreenshotUrl = blobClient.Uri.ToString();
                // -----------------------------------
            }

            var auth = await AuthState.GetAuthenticationStateAsync();
            newBet.UserId = auth.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value ?? string.Empty;
            newBet.UserName = auth.User.Identity?.Name ?? "Unknown";
            newBet.Status = "Pending";
            newBet.CreatedAt = DateTime.UtcNow;

            using var context = DbFactory.CreateDbContext(); 
            context.Bets.Add(newBet);
            await context.SaveChangesAsync();

            await NotifyDiscord(newBet);

            await HubContext.Clients.Group("Admins").SendAsync("ReceiveAdminNotification", $"New pick submitted by {newBet.UserName}");
            
            SuccessMessage = "Pick successfully sent for approval.";
            newBet = new Bet { Odds = 1.0m }; 
            uploadedFile = null;
            
            // Reset to page 1 to see the new bet
            betsPage = 1;
            await LoadData();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Submission Error: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task NotifyDiscord(Bet bet)
    {
        try 
        {
            var webhookUrl = Config["Discord:WebhookUrl"];
            if (!string.IsNullOrEmpty(webhookUrl))
            {
                var client = HttpClientFactory.CreateClient();
                var messageContent = new 
                { 
                    content = $"**New Pick Placed!**\n" +
                                $"**User:** {bet.UserName}\n" +
                                $"[Approve Here](https://castle-of-happiness-gmcwb5eeafacfphc.canadacentral-01.azurewebsites.net/admin?ReviewBetId={bet.Id})\n" +
                                (string.IsNullOrEmpty(bet.ScreenshotUrl) ? "" : $"[View Screenshot]({bet.ScreenshotUrl})\n") +
                                $"------------------------------\n"
                };
                await client.PostAsJsonAsync(webhookUrl, messageContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Discord Notification Failed: {ex.Message}");
        }
    }

    private async Task CancelBet(Bet bet)
    {
        if (bet.Status != "Pending") return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to cancel this bet?");
        if (confirmed)
        {
            try
            {
                using var context = DbFactory.CreateDbContext();
                var dbBet = await context.Bets.FindAsync(bet.Id);
                
                if (dbBet != null && dbBet.UserId == userId && dbBet.Status == "Pending")
                {
                    dbBet.Status = "Cancelled";
                    await context.SaveChangesAsync();

                    await HubContext.Clients.Group("Admins").SendAsync("ReceiveAdminNotification", $"Pick cancelled by {dbBet.UserName}");

                    SuccessMessage = "Bet cancelled successfully.";
                    await LoadData();
                }
                else
                {
                    ErrorMessage = "Unable to cancel bet. It may have already been processed.";
                    await LoadData();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error cancelling bet: {ex.Message}";
                Console.WriteLine(ex);
            }
        }
    }
    
    private string GetRowClass(Bet bet)
    {
        if (!string.IsNullOrEmpty(bet.Outcome))
        {
            return bet.Outcome switch
            {
                "Won" => "table-success",
                "Lost" => "table-danger",
                "Void" => "table-secondary",
                _ => ""
            };
        }
        
        return bet.Status switch
        {
            "Rejected" => "table-danger",
            "Cancelled" => "table-secondary",
            "Approved" => "table-warning",
            "Pending" => "table-warning",
            _ => ""
        };
    }

    private string GetBalanceClass(decimal balance) => balance switch
    {
        >= 0 => "text-success",
        _ => "text-danger"
    };
}