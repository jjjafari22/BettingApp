@page "/"
@rendermode @(new InteractiveServerRenderMode(prerender: true))
@using Microsoft.AspNetCore.SignalR
@using BettingApp.Hubs
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using BettingApp.Data
@using Microsoft.EntityFrameworkCore 
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav
@inject IWebHostEnvironment Env
@inject IHubContext<BetHub> HubContext
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

@if (IsLoading)
{
    <div class="alert alert-info">Loading your data...</div>
}

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> 
        <pre>@ErrorMessage</pre>
    </div>
}

<div class="container mt-4">
    <div class="card bg-light mb-4">
        <div class="card-body text-center">
            <h3>Balance</h3>
            <h1 class="display-4 @GetBalanceClass(Balance)">@Balance.ToString("N0") kr</h1>
            <small class="text-muted">
                Available Credit: <strong>@AvailableCredit.ToString("N0") kr</strong> 
                (Limit: @CreditLimit.ToString("N0") kr)
            </small>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">New Bet</div>
        <div class="card-body">
            <EditForm Model="@newBet" OnValidSubmit="PlaceBet" FormName="PlaceBetForm">
                <DataAnnotationsValidator />
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Bet Amount (NOK) *</label>
                        @* Use @bind-Value:after to trigger UI update for payout calc *@
                        <InputNumber @bind-Value="newBet.AmountNOK" @bind-Value:after="StateHasChanged" class="form-control" />
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label>Odds *</label>
                        <InputNumber @bind-Value="newBet.Odds" @bind-Value:after="StateHasChanged" class="form-control" step="0.01" />
                    </div>

                    <div class="col-md-4 mb-3">
                        <label>Potential Payout</label>
                        <input type="text" class="form-control" value="@((newBet.AmountNOK * newBet.Odds).ToString("N2")) kr" disabled />
                    </div>
                </div>

                <div class="mb-3">
                    <label>Screenshot</label>
                    <InputFile OnChange="HandleFileSelected" class="form-control" accept="image/*" />
                </div>

                <button type="submit" class="btn btn-primary w-100">Submit Bet</button>
            </EditForm>
        </div>
    </div>

    <h4>My Bets History</h4>
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Bet Amount</th>
                <th>Odds</th>
                <th>Potential Payout</th>
                <th>Screenshot</th> 
                <th>Status</th>
                <th>Bet Outcome</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var bet in myBets)
            {
                <tr class="@GetRowClass(bet.Status)">
                    <td>@bet.CreatedAt.ToLocalTime().ToShortDateString()</td>
                    <td>@bet.CreatedAt.ToLocalTime().ToShortTimeString()</td>
                    <td>@bet.AmountNOK kr</td>
                    <td>@bet.Odds.ToString("N2")</td>
                    <td>@bet.PotentialPayout.ToString("N2") kr</td>
                    <td>
                        @if (!string.IsNullOrEmpty(bet.ScreenshotUrl))
                        {
                            <a href="@bet.ScreenshotUrl" target="_blank" class="btn btn-sm btn-outline-primary">View Image</a>
                        }
                        else
                        {
                            <span class="text-muted">None</span>
                        }
                    </td>
                    <td>@bet.Status</td>
                    <td>
                        @if (bet.Outcome == "Won")
                        {
                            <span class="d-inline-block bg-success border border-dark" style="width: 20px; height: 20px;" title="Won"></span>
                            <span class="ms-1">Won</span>
                        }
                        else if (bet.Outcome == "Lost")
                        {
                            <span class="d-inline-block bg-danger border border-dark" style="width: 20px; height: 20px;" title="Lost"></span>
                            <span class="ms-1">Lost</span>
                        }
                        else if (bet.Outcome == "Void")
                        {
                            <span class="d-inline-block bg-warning border border-dark" style="width: 20px; height: 20px;" title="Void"></span>
                            <span class="ms-1">Void</span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h4 class="mt-5">My Transactions</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Platform</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            @if (myTransactions.Count == 0)
            {
                <tr><td colspan="4" class="text-center text-muted">No transactions found.</td></tr>
            }
            @foreach (var t in myTransactions)
            {
                <tr>
                    <td>@t.Date.ToLocalTime().ToString("g")</td>
                    <td>
                        <span class="badge @(t.Type == "Deposit" ? "bg-success" : "bg-warning")">
                            @t.Type
                        </span>
                    </td>
                    <td>@t.Platform</td>
                    <td>@t.AmountNOK kr</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private Bet newBet { get; set; } = new() { Odds = 1.0m }; // Initialize Odds to 1
    private List<Bet> myBets = new();
    private List<Transaction> myTransactions = new();
    
    private decimal CreditLimit = 0;
    private decimal Balance = 0;
    private decimal AvailableCredit = 1000;

    private IBrowserFile? uploadedFile;
    private HubConnection? hubConnection;
    private string userId;
    
    private bool IsLoading = true;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var auth = await AuthState.GetAuthenticationStateAsync();
            userId = auth.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (userId != null)
            {
                newBet.UserId = userId;
                newBet.UserName = auth.User.Identity?.Name ?? "Unknown";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Startup Error: {ex.Message}";
            Console.WriteLine(ex);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                if (userId != null)
                {
                    await LoadData();
                    await SetupSignalR();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error loading data: {ex.Message}";
                Console.WriteLine(ex);
            }
            finally
            {
                IsLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadData()
    {      
        using var context = DbFactory.CreateDbContext();

        var user = await context.Users.AsNoTracking()
            .FirstOrDefaultAsync(u => u.Id == userId);
        
        if (user != null)
        {
            CreditLimit = user.CreditLimit; 
        }

        myBets = await context.Bets
                        .Where(b => b.UserId == userId)
                        .OrderByDescending(b => b.CreatedAt)
                        .AsNoTracking()
                        .ToListAsync();

        myTransactions = await context.Transactions
                        .Where(t => t.UserId == userId)
                        .OrderByDescending(t => t.Date)
                        .AsNoTracking()
                        .ToListAsync();

        var totalDeposits = myTransactions.Where(t => t.Type == "Deposit").Sum(t => t.AmountNOK);
        var totalWithdrawals = myTransactions.Where(t => t.Type == "Withdrawal").Sum(t => t.AmountNOK);
        
        // 1. Calculate Winnings: Add Potential Payout only for bets that are explicitly "Won"
        var winnings = myBets.Where(b => b.Outcome == "Won").Sum(b => b.PotentialPayout);

        // 2. Calculate Liability (Stakes):
        // We deduct the Bet Amount if the bet is "Pending" OR "Approved" (Active/In-Play).
        // We also keep the deduction if it is "Lost" or "Won" (because Status stays "Approved").
        // We ONLY stop deducting (refund) if the Outcome is "Void" or the Status is "Rejected".
        var liability = myBets.Where(b => 
            b.Status == "Pending" || 
            (b.Status == "Approved" && b.Outcome != "Void")
        ).Sum(b => b.AmountNOK);

        // 3. Final Balance Formula
        Balance = totalDeposits - totalWithdrawals - liability + winnings;

        AvailableCredit = Balance + CreditLimit;
    }

    private async Task SetupSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/bethub"))
            .Build();

        hubConnection.On<string>("ReceiveUpdate", async (message) =>
        {
            await LoadData();
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        await hubConnection.InvokeAsync("JoinUserGroup", userId);
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
    }

    private async Task PlaceBet()
    {
        // Reset error message at the start of attempt
        ErrorMessage = null;

        // 1. Validation Logic: Check if bet exceeds available credit
        if (newBet.AmountNOK > AvailableCredit)
        {
            ErrorMessage = $"You cannot bet more than your available credit ({AvailableCredit:N0} kr).";
            return;
        }

        if (uploadedFile != null)
        {
            var uploadPath = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadPath);
            var fileName = $"{Guid.NewGuid()}_{uploadedFile.Name}";
            var path = Path.Combine(uploadPath, fileName);
            await using FileStream fs = new(path, FileMode.Create);
            await uploadedFile.OpenReadStream(maxAllowedSize: 5000000).CopyToAsync(fs);
            newBet.ScreenshotUrl = $"/uploads/{fileName}";
        }

        var auth = await AuthState.GetAuthenticationStateAsync();
        newBet.UserId = auth.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
        newBet.UserName = auth.User.Identity?.Name;
        newBet.Status = "Pending";
        newBet.CreatedAt = DateTime.UtcNow;

        using var context = DbFactory.CreateDbContext(); 
        context.Bets.Add(newBet);
        await context.SaveChangesAsync();

        await HubContext.Clients.Group("Admins").SendAsync("ReceiveAdminNotification", $"New bet submitted by {newBet.UserName}");
        
        newBet = new Bet { Odds = 1.0m }; // Reset with Odds 1
        uploadedFile = null;

        await LoadData();
        StateHasChanged();
    }
    
    private string GetRowClass(string status) => status switch
    {
        "Approved" => "table-success",
        "Rejected" => "table-danger",
        _ => "table-warning"
    };

    private string GetBalanceClass(decimal balance) => balance switch
    {
        >= 0 => "text-success",
        _ => "text-danger"
    };
}