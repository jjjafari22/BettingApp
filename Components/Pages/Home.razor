@page "/"
@rendermode @(new InteractiveServerRenderMode(prerender: true))
@using Microsoft.AspNetCore.SignalR
@using BettingApp.Hubs
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using BettingApp.Data
@using Microsoft.EntityFrameworkCore 
@using Azure.Storage.Blobs
@using Azure.Storage.Blobs.Models
@using BettingApp.Services
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav
@inject BlobServiceClient BlobService
@inject IHubContext<BetHub> HubContext
@inject IConfiguration Config
@inject DiscordNotificationService DiscordService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Dashboard</PageTitle>

<style>
    .modal { overscroll-behavior: contain; outline: none; }
    .review-modal-content { max-height: 90vh; height: 90vh; display: flex; flex-direction: column; overflow: hidden; overscroll-behavior: contain; }
    .review-modal-body { display: flex; flex-direction: column; flex: 1; min-height: 0; padding: 0; background-color: #212529; overflow-y: auto; overscroll-behavior: contain; position: relative; }
    .review-image-container { flex-grow: 1; min-height: 0; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow: hidden; position: relative; }
    .review-image { max-height: 100%; max-width: 100%; object-fit: contain; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); z-index: 20; background-color: rgba(0, 0, 0, 0.4); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: background-color 0.2s; }
    .nav-arrow:hover:not(:disabled) { background-color: rgba(0, 0, 0, 0.7); }
    .nav-arrow:disabled { opacity: 0; pointer-events: none; }
    .nav-arrow-left { left: 10px; }
    .nav-arrow-right { right: 10px; }
    .review-controls-container { flex-shrink: 0; background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 1rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 10; }
    .action-btn { width: 100%; display: block; margin: 0 auto; font-weight: bold; font-size: inherit; white-space: nowrap; }
    @@media (min-width: 992px) { 
        .action-btn { width: 80%; }
        .review-modal-content { max-height: 95vh; height: 95vh; margin: 0.5rem; }
        .review-controls-container { padding: 0.75rem; }
    }
</style>

@if (IsLoading)
{
    <div class="alert alert-info">Loading your data...</div>
}

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger"><strong>Error:</strong> <pre>@ErrorMessage</pre></div>
}

@if (!string.IsNullOrEmpty(SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Success!</strong> @SuccessMessage
        <button type="button" class="btn-close" @onclick="() => SuccessMessage = null" aria-label="Close"></button>
    </div>
}

@if (viewBetModel != null)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.85);" tabindex="-1" role="dialog" @ref="viewModalRef" @onkeydown="OnModalKeyDown">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content review-modal-content" @ontouchstart="HandleTouchStart" @ontouchend="HandleTouchEnd">
                <div class="modal-header py-2 flex-shrink-0">
                    <div class="d-flex align-items-center w-100 overflow-hidden">
                        <h5 class="modal-title fs-6 me-2 flex-grow-1 text-truncate">
                            Bet #@viewBetModel.Id 
                            @{ var (statusText, statusClass) = GetDisplayStatus(viewBetModel); }
                            <span class="badge ms-2 @statusClass">@statusText</span>
                        </h5>
                        <button type="button" class="btn-close flex-shrink-0" @onclick="CloseViewModal"></button>
                    </div>
                </div>
                <div class="d-block d-md-none bg-dark text-white-50 text-center py-1 small border-bottom border-secondary">
                    <i class="bi bi-arrows-move"></i> Swipe left/right to navigate
                </div>
                <div class="modal-body review-modal-body">
                    <div class="review-image-container">
                        <button class="nav-arrow nav-arrow-left shadow-lg" @onclick="() => NavigateView(-1)" disabled="@(currentViewIndex <= 0)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        @if (!string.IsNullOrEmpty(viewBetModel.ScreenshotUrl))
                        {
                             <img src="@viewBetModel.ScreenshotUrl" class="review-image rounded" alt="Bet Screenshot" />
                        }
                        else
                        {
                             <div class="text-white-50 fst-italic text-center">
                                <i class="bi bi-image-fill display-1 d-block mb-3"></i>
                                <span>No Image Available</span>
                             </div>
                        }
                        <button class="nav-arrow nav-arrow-right shadow-lg" @onclick="() => NavigateView(1)" disabled="@(currentViewIndex >= myBets.Count - 1)">
                           <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="review-controls-container">
                        <div class="row g-3 text-center mb-3">
                            <div class="col-4">
                                <label class="text-muted small d-block">Amount</label>
                                <span class="fw-bold fs-5">@GetAmountDisplay(viewBetModel)</span>
                             </div>
                            <div class="col-4">
                                 <label class="text-muted small d-block">Odds</label>
                                 <span class="fw-bold fs-5">@GetOddsDisplay(viewBetModel)</span>
                             </div>
                            <div class="col-4">
                                <label class="text-muted small d-block">@GetPayoutLabel(viewBetModel)</label>
                                <span class="fw-bold fs-5 @(viewBetModel.Status == "Lost" ? "text-danger" : "text-success")">
                                    @GetPayoutDisplay(viewBetModel)
                                </span>
                            </div>
                        </div>
                        @if (viewBetModel.Status == "Pending")
                        {
                            <div class="d-grid">
                                <button class="btn btn-outline-danger btn-lg fw-bold" @onclick="() => CancelBet(viewBetModel)">
                                    <i class="bi bi-trash3-fill me-2"></i>Cancel Pick
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<div class="container mt-4">
    <div class="card bg-light mb-4">
        <div class="card-body text-center">
            <h3>Balance</h3>
            <h1 class="display-4 @GetBalanceClass(Balance)">@Balance.ToString("N0") kr</h1>
            <small class="text-muted">
                Available Credit: <strong>@AvailableCredit.ToString("N0") kr</strong> 
                (Credit Limit: @CreditLimit.ToString("N0") kr)
            </small>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">New Pick</div>
        <div class="card-body">
            <EditForm Model="@newBet" OnValidSubmit="PlaceBet" FormName="PlaceBetForm">
                <DataAnnotationsValidator />
                <div class="mb-3">
                    <label class="form-label">Screenshots *</label>
                    <InputFile OnChange="HandleFileSelected" class="form-control" accept="image/*" multiple />
                    <div class="form-text text-muted">You can select multiple screenshots to upload multiple picks at once.</div>
                    @if (uploadedFiles.Any())
                    {
                        <div class="mt-2 text-success small">
                              <i class="bi bi-check-circle me-1"></i> @uploadedFiles.Count file(s) selected
                        </div>
                    }
                </div>
                 <button type="submit" class="btn btn-primary w-100" disabled="@IsSubmitting">
                   @if (IsSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="ms-2">Sending @(uploadedFiles.Count > 1 ? "Picks" : "Pick")...</span>
                    }
                    else
                    {
                       <span>Send Pick(s)</span>
                    }
                </button>
            </EditForm>
        </div>
    </div>

    <h4>My Bets History (@totalBets)</h4>
    <div class="table-responsive">
        <table class="table table-sm table-striped table-hover align-middle text-nowrap">
            <thead class="table-dark">
                <tr>
                    <th style="width: 150px;">Action</th>
                    <th>Last Updated</th>
                    <th>Bet Amount</th>
                    <th>Odds</th>
                    <th>Potential Payout</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                 @foreach (var bet in myBets)
                 {
                    var (statusText, statusClass) = GetDisplayStatus(bet);
                    <tr class="@GetRowClass(bet)">
                        <td>
                            <button class="btn btn-primary btn-sm action-btn" @onclick="() => OpenViewModal(bet)">
                                 <i class="bi bi-eye me-1"></i> View Bet
                            </button>
                        </td>
                        <td>@ToUserLocal(bet.UpdatedAt).ToString("g")</td>
                        <td>@GetAmountDisplay(bet)</td>
                        <td>@GetOddsDisplay(bet)</td>
                        <td>@GetPayoutDisplay(bet)</td>
                        <td><span class="badge @statusClass">@statusText</span></td>
                    </tr>
                }
            </tbody>
        </table>
        
        <div class="d-flex justify-content-between align-items-center mt-2 mb-4">
            <button class="btn btn-outline-secondary btn-sm" @onclick="PrevBetsPage" disabled="@(betsPage <= 1)">
                <i class="bi bi-arrow-left"></i> Previous
            </button>
            <span class="text-muted">Page @betsPage</span>
            <button class="btn btn-outline-secondary btn-sm" @onclick="NextBetsPage" disabled="@(!hasMoreBets)">
                Next <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>
</div>

@code {
    private Bet newBet { get; set; } = new() { Odds = 1.0m }; 
    private List<Bet> myBets = new();
    private decimal CreditLimit = 0;
    private decimal Balance = 0;
    private decimal AvailableCredit = 1000;
    private IReadOnlyList<IBrowserFile> uploadedFiles = new List<IBrowserFile>();
    
    private HubConnection? hubConnection;
    private string userId = string.Empty;
    private string userName = string.Empty;
    
    private bool IsLoading = true;
    private bool IsSubmitting = false;
    private string? ErrorMessage;
    private string? SuccessMessage;

    private Bet? viewBetModel;
    private ElementReference viewModalRef;
    private bool shouldFocusModal = false;

    private int betsPage = 1;
    private bool hasMoreBets = false;
    private int totalBets = 0;
    private const int PageSize = 20;
    
    private int currentViewIndex = -1;
    private double touchStartX = 0;
    private double touchEndX = 0;

    private int TimezoneOffset { get; set; }

    private DateTime ToUserLocal(DateTime utcDate)
    {
        if (utcDate == DateTime.MinValue || utcDate == DateTime.MaxValue) return utcDate;
        return utcDate.AddMinutes(-TimezoneOffset);
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var auth = await AuthState.GetAuthenticationStateAsync();
            var uid = auth.User.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            if (!string.IsNullOrEmpty(uid))
            {
                userId = uid;
                userName = auth.User.Identity?.Name ?? "Unknown";
                
                using var context = DbFactory.CreateDbContext();
                var user = await context.Users.AsNoTracking()
                    .Select(u => new { u.Id, u.IsAdmin }) 
                    .FirstOrDefaultAsync(u => u.Id == userId);

                if (user != null && user.IsAdmin)
                {
                    Nav.NavigateTo("/admin");
                    return; 
                }
                newBet.UserId = userId;
                newBet.UserName = userName;
            }
        }
        catch (Exception ex) when (ex is not NavigationException) // <--- Add this filter
        {
            ErrorMessage = $"Startup Error: {ex.Message}";
            Console.WriteLine(ex);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                TimezoneOffset = await JSRuntime.InvokeAsync<int>("getBrowserTimeZoneOffset");
                if (!string.IsNullOrEmpty(userId))
                {
                    await LoadData();
                    await SetupSignalR();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error loading data: {ex.Message}";
                Console.WriteLine(ex);
            }
            finally
            {
                IsLoading = false;
                StateHasChanged();
            }
        }

        if (shouldFocusModal)
        {
            shouldFocusModal = false;
            try { await viewModalRef.FocusAsync(); } catch { }
        }
    }

    private async Task LoadData()
    {      
        using var context = DbFactory.CreateDbContext();
        var user = await context.Users.AsNoTracking().FirstOrDefaultAsync(u => u.Id == userId);
        if (user != null)
        {
            CreditLimit = user.CreditLimit;
            // PERFORMANCE FIX: Use stored balance instead of calculating from history
            Balance = user.Balance;
        }

        AvailableCredit = Balance + CreditLimit;
        await LoadBetsList();
    }
    
    private async Task LoadBetsList()
    {
        using var context = DbFactory.CreateDbContext();
        totalBets = await context.Bets.CountAsync(b => b.UserId == userId);
        
        myBets = await context.Bets
            .Where(b => b.UserId == userId)
            .OrderByDescending(b => b.UpdatedAt) 
            .Skip((betsPage - 1) * PageSize)
            .Take(PageSize)
            .AsNoTracking()
            .ToListAsync();
        hasMoreBets = totalBets > (betsPage * PageSize);
    }
    
    private async Task NextBetsPage()
    {
        betsPage++;
        await LoadBetsList();
    }

    private async Task PrevBetsPage()
    {
        if (betsPage > 1)
        {
            betsPage--;
            await LoadBetsList();
        }
    }

    private async Task SetupSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/bethub"))
            .Build();
        hubConnection.On<string>("ReceiveUpdate", async (message) =>
        {
            await LoadData();
            await InvokeAsync(StateHasChanged);
        });
        await hubConnection.StartAsync();
        await hubConnection.InvokeAsync("JoinUserGroup", userId);
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFiles = e.GetMultipleFiles(20);
    }

    private void OpenViewModal(Bet bet)
    {
        currentViewIndex = myBets.FindIndex(b => b.Id == bet.Id);
        viewBetModel = bet;
        shouldFocusModal = true;
    }

    private void CloseViewModal()
    {
        viewBetModel = null;
    }

    private void NavigateView(int direction)
    {
        if (myBets.Count == 0) return;
        int newIndex = currentViewIndex + direction;

        if (newIndex >= 0 && newIndex < myBets.Count)
        {
            currentViewIndex = newIndex;
            viewBetModel = myBets[currentViewIndex];
        }
    }

    private void OnModalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") CloseViewModal();
        else if (e.Key == "ArrowRight") NavigateView(1);
        else if (e.Key == "ArrowLeft") NavigateView(-1);
    }

    private void HandleTouchStart(TouchEventArgs e)
    {
        touchStartX = e.Touches[0].ClientX;
    }

    private void HandleTouchEnd(TouchEventArgs e)
    {
        touchEndX = e.ChangedTouches[0].ClientX;
        var diff = touchStartX - touchEndX;
        if (Math.Abs(diff) > 50)
        {
            if (diff > 0) NavigateView(1);
            else NavigateView(-1);
        }
    }

    private async Task PlaceBet()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsSubmitting = true;

        try
        {
            if (!uploadedFiles.Any())
            {
                ErrorMessage = "You must upload at least one screenshot.";
                IsSubmitting = false;
                return;
            }

            await LoadData(); // Refresh Balance
            if (AvailableCredit <= 0) 
            {
                ErrorMessage = "Your available credit is zero. To send a pick, you need to deposit more money.";
                IsSubmitting = false;
                return;
            }
            
            using var context = DbFactory.CreateDbContext();
            
            // --- BALANCE UPDATE LOGIC ---
            // We need to fetch the tracked user to update balance (if needed)
            var dbUser = await context.Users.FirstOrDefaultAsync(u => u.Id == userId);
            
            // Note: Since AmountNOK is null here (Admin sets it later), we do NOT deduct balance yet.
            // Balance is deducted when Admin approves the bet in Admin.razor.
            
            var containerClient = BlobService.GetBlobContainerClient("uploads");
            await containerClient.CreateIfNotExistsAsync(PublicAccessType.Blob);
            await containerClient.SetAccessPolicyAsync(PublicAccessType.Blob);

            var betsToNotify = new List<Bet>();
            foreach (var file in uploadedFiles)
            {
                var resizedFile = await file.RequestImageFileAsync("image/jpeg", 1200, 1200);
                var fileName = $"{Guid.NewGuid()}.jpg";
                var blobClient = containerClient.GetBlobClient(fileName);
                
                await using var stream = resizedFile.OpenReadStream(maxAllowedSize: 3000000);
                var headers = new BlobHttpHeaders { ContentType = "image/jpeg" };
                await blobClient.UploadAsync(stream, new BlobUploadOptions { HttpHeaders = headers });

                var bet = new Bet
                {
                    UserId = userId,
                    UserName = userName,
                    ScreenshotUrl = blobClient.Uri.ToString(),
                    Status = "Pending",
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow,
                    Odds = 1.0m,
                    AmountNOK = null 
                };
                context.Bets.Add(bet);
                betsToNotify.Add(bet);
            }

            await context.SaveChangesAsync();
            
            foreach (var bet in betsToNotify)
            {
                await DiscordService.NotifyAdminNewPickAsync(bet);
            }

            var msg = betsToNotify.Count == 1 
                ? $"New pick submitted by {userName}" 
                : $"{betsToNotify.Count} new picks submitted by {userName}";
            await HubContext.Clients.Group("Admins").SendAsync("ReceiveAdminNotification", msg);

            SuccessMessage = betsToNotify.Count == 1 
                ? "Pick successfully sent for approval." 
                : $"{betsToNotify.Count} picks successfully sent for approval.";
            
            newBet = new Bet { Odds = 1.0m, UserId = userId, UserName = userName };
            uploadedFiles = new List<IBrowserFile>();
            betsPage = 1;
            await LoadData();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Submission Error: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task CancelBet(Bet bet)
    {
        if (bet.Status != "Pending") return;
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to cancel this bet?");
        if (confirmed)
        {
            try
            {
                using var context = DbFactory.CreateDbContext();
                // Load user and bet to update balance
                var dbBet = await context.Bets.FindAsync(bet.Id);
                var dbUser = await context.Users.FindAsync(userId);
                
                if (dbBet != null && dbBet.UserId == userId && dbBet.Status == "Pending")
                {
                    // If the bet had an amount set (rare for Pending, but possible if Admin edited it), refund it
                    if (dbBet.AmountNOK.HasValue && dbBet.AmountNOK > 0 && dbUser != null)
                    {
                        dbUser.Balance += dbBet.AmountNOK.Value;
                    }

                    dbBet.Status = "Cancelled";
                    dbBet.UpdatedAt = DateTime.UtcNow;
                    
                    await context.SaveChangesAsync();
                    await HubContext.Clients.Group("Admins").SendAsync("ReceiveAdminNotification", $"Pick cancelled by {dbBet.UserName}");

                    SuccessMessage = "Bet cancelled successfully.";
                    if (viewBetModel?.Id == bet.Id) CloseViewModal();
                    await LoadData();
                }
                else
                {
                    ErrorMessage = "Unable to cancel bet. It may have already been processed.";
                    CloseViewModal(); 
                    await LoadData();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error cancelling bet: {ex.Message}";
                Console.WriteLine(ex);
            }
        }
    }
    
    private (string Text, string Class) GetDisplayStatus(Bet bet)
    {
        return bet.Status switch
        {
            "Pending" => ("Pending", "bg-warning text-dark"),
            "Approved" => ("Approved", "bg-primary"),
            "Rejected" => ("Rejected", "bg-danger"),
            "Cancelled" => ("Cancelled", "bg-secondary"),
            "Won" => ("Won", "bg-success"),
            "Lost" => ("Lost", "bg-danger"),
            "Void" => ("Void", "bg-secondary"),
            _ => (bet.Status, "bg-secondary")
        };
    }

    private string GetAmountDisplay(Bet bet)
    {
        if (bet.Status == "Pending" || bet.Status == "Cancelled") return "-";
        return (bet.AmountNOK?.ToString("N0") ?? "0") + " kr";
    }

    private string GetOddsDisplay(Bet bet)
    {
        if (bet.Status == "Pending" || bet.Status == "Cancelled") return "-";
        return bet.Odds.ToString("N2");
    }

    private string GetPayoutDisplay(Bet bet)
    {
        if (bet.Status == "Pending" || bet.Status == "Cancelled") return "-";
        if (bet.Status == "Lost") return "0 kr";
        if (bet.Status == "Void") return (bet.AmountNOK?.ToString("N0") ?? "0") + " kr";
        return bet.PotentialPayout.ToString("N0") + " kr";
    }

    private string GetPayoutLabel(Bet bet)
    {
        if (bet.Status == "Approved" || bet.Status == "Rejected" || bet.Status == "Pending")
            return "Potential Payout";
        return "Payout";
    }

    private string GetRowClass(Bet bet)
    {
        var (_, statusClass) = GetDisplayStatus(bet);
        return statusClass switch
        {
            "bg-success" => "table-success",
            "bg-danger" => "table-danger",
            "bg-warning text-dark" => "table-warning",
            "bg-secondary" => "table-secondary",
            "bg-primary" => "", 
            _ => ""
        };
    }

    private string GetBalanceClass(decimal balance) => balance switch
    {
        >= 0 => "text-success",
        _ => "text-danger"
    };
}