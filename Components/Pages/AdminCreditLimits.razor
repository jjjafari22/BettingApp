@page "/admin/creditlimits"
@using BettingApp.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.SignalR
@using BettingApp.Hubs
@attribute [Authorize]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@inject IHubContext<BetHub> HubContext
@rendermode InteractiveServer
@implements IAsyncDisposable

<h3>User Credit Limits</h3>

@* --- PERSISTENT NOTIFICATION AREA --- *@
@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i> @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@if (!isAdmin)
{
    <p>You are not authorized to view this page.</p>
}
else if (users == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">Search User</span>
                <input type="text" class="form-control" placeholder="Username..." 
                     @bind="searchTerm" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-sm table-striped table-hover align-middle text-nowrap">
            <thead class="table-dark">
                <tr>
                    <th>Last Updated</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>User</th>
                    <th>Current Credit Limit (NOK)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in FilteredUsers)
                {
                    <tr>
                        <td>@ToUserLocal(user.UpdatedAt).ToString("g")</td>
                        <td>@user.FirstName</td>
                        <td>@user.LastName</td>
                        <td>@user.UserName</td>
                        <td>
                            @* Since CreditLimit is now an INT, we can use simple binding.
                               step="100" suggests increments, but user can type any integer.
                            *@
                            <input type="number" class="form-control form-control-sm" style="width: 150px;"
                                   @bind="user.CreditLimit" step="100" />
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" @onclick="() => SaveCreditLimit(user)">
                                Update
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<ApplicationUser>? users;
    private string searchTerm = "";
    private bool isAdmin = false;
    private string? successMessage; 
    private string? currentAdminName;
    private int TimezoneOffset { get; set; }
    private HubConnection? hubConnection;

    private IEnumerable<ApplicationUser> FilteredUsers => 
        string.IsNullOrWhiteSpace(searchTerm) 
            ? users ?? new List<ApplicationUser>() 
            : (users ?? new List<ApplicationUser>()) 
                .Where(u => u.UserName != null && 
                            u.UserName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentAdminName = user.Identity?.Name;

        if (user.Identity?.IsAuthenticated == true)
        {
            using var context = DbFactory.CreateDbContext();
            var currentUser = await context.Users
                .AsNoTracking()
                .FirstOrDefaultAsync(u => u.UserName == user.Identity.Name);
            isAdmin = currentUser?.IsAdmin ?? false;
        }

        if (isAdmin)
        {
            await LoadUsers();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && isAdmin)
        {
            try {
                TimezoneOffset = await JSRuntime.InvokeAsync<int>("getBrowserTimeZoneOffset");
                await SetupSignalR();
                StateHasChanged();
            } catch { }
        }
    }
    
    private async Task SetupSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/bethub"))
            .Build();

        hubConnection.On<string>("ReceiveAdminNotification", async (message) =>
        {
            await LoadUsers();
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        await hubConnection.InvokeAsync("JoinAdminGroup");
    }

    private DateTime ToUserLocal(DateTime utcDate)
    {
        if (utcDate == DateTime.MinValue) return utcDate;
        return utcDate.AddMinutes(-TimezoneOffset);
    }

    private async Task LoadUsers()
    {
        using var context = DbFactory.CreateDbContext();
        // Sort by UpdatedAt descending to show most recently modified users first
        users = await context.Users
            .Where(u => !u.IsAdmin)
            .OrderByDescending(u => u.UpdatedAt)
            .ToListAsync();
    }

    private async Task SaveCreditLimit(ApplicationUser userToUpdate)
    {
        using var context = DbFactory.CreateDbContext();
        var dbUser = await context.Users.FindAsync(userToUpdate.Id);
        
        if (dbUser != null)
        {
            var oldLimit = dbUser.CreditLimit;
            dbUser.CreditLimit = userToUpdate.CreditLimit;
            dbUser.UpdatedAt = DateTime.UtcNow; 

            context.AuditLogs.Add(new AuditLog
            {
                AdminUserName = currentAdminName ?? "Unknown",
                Action = "Changed Credit Limit",
                TargetUserName = userToUpdate.UserName ?? "Unknown",
                Details = $"Old: {oldLimit:N0}, New: {userToUpdate.CreditLimit:N0}"
            });

            await context.SaveChangesAsync();
            
            await HubContext.Clients.Group("Admins").SendAsync("ReceiveAdminNotification", 
                $"Credit limit updated for {userToUpdate.UserName}");

            successMessage = $"Credit limit updated for {userToUpdate.UserName}!";
            
            await LoadUsers();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}