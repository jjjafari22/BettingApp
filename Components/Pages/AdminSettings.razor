@page "/admin/settings"
@using BettingApp.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<h3>Admin Settings</h3>

@if (!hasAccess)
{
    <div class="alert alert-danger">You are not authorized to view this page.</div>
}
else if (isLoading)
{
    <p><em>Loading settings...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Global Betting Limits
                </div>
                <div class="card-body">
                    @if (showSuccess)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            Settings updated successfully!
                            <button type="button" class="btn-close" @onclick="() => showSuccess = false"></button>
                        </div>
                    }

                    <EditForm Model="settings" OnValidSubmit="SaveSettings">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label for="minBet" class="form-label">Minimum Bet Amount (NOK)</label>
                            <InputNumber id="minBet" class="form-control" @bind-Value="settings.MinBetAmount" />
                            <div class="form-text">The minimum amount required for a single bet.</div>
                        </div>

                        <div class="mb-3">
                            <label for="maxPayout" class="form-label">Max Payout per Bet (NOK)</label>
                            <InputNumber id="maxPayout" class="form-control" @bind-Value="settings.MaxPayout" />
                            <div class="form-text">The maximum potential payout allowed for a single bet.</div>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private SystemSetting settings = new();
    private bool hasAccess = false;
    private bool isLoading = true;
    private bool showSuccess = false;
    private string? currentAdminName;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentAdminName = user.Identity?.Name; // Capture Admin Name

        using var context = DbFactory.CreateDbContext();
        if (user.Identity?.IsAuthenticated == true)
        {
            var dbUser = await context.Users.AsNoTracking()
                .FirstOrDefaultAsync(u => u.UserName == user.Identity.Name);
            hasAccess = dbUser?.IsAdmin ?? false;
        }

        if (hasAccess)
        {
            // Load settings or create default if none exist
            var existingSettings = await context.Settings.FirstOrDefaultAsync();
            if (existingSettings == null)
            {
                settings = new SystemSetting { MinBetAmount = 100m, MaxPayout = 10000m };
                context.Settings.Add(settings);
                await context.SaveChangesAsync();
            }
            else
            {
                settings = existingSettings;
            }
        }
        isLoading = false;
    }

    private async Task SaveSettings()
    {
        showSuccess = false;
        using var context = DbFactory.CreateDbContext();
        
        // Fetch fresh entity to update
        var dbSettings = await context.Settings.FirstOrDefaultAsync();
        if (dbSettings != null)
        {
            // Capture old values for log
            var oldMinBet = dbSettings.MinBetAmount;
            var oldPayout = dbSettings.MaxPayout;

            dbSettings.MinBetAmount = settings.MinBetAmount;
            dbSettings.MaxPayout = settings.MaxPayout;
            // NEW: Add Audit Log
            context.AuditLogs.Add(new AuditLog
            {
                AdminUserName = currentAdminName ?? "Unknown",
                Action = "Changed System Settings",
                TargetUserName = "System",
                Details = $"MinBet: {oldMinBet}->{settings.MinBetAmount}, MaxPayout: {oldPayout}->{settings.MaxPayout}"
            });
            await context.SaveChangesAsync();
            showSuccess = true;
        }
    }
}